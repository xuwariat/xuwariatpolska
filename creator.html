<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kreator danych â€“ DowÃ³d PL</title>
  <link rel="stylesheet" href="assets/style.css">
  <base href="/dowodplska/">
  <style>
    body { background:#101317; color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
    form { max-width:400px; width:100%; display:flex; flex-direction:column; gap:10px; }
    input, select, button { padding:10px; border:none; border-radius:10px; }
    button { background:#2563eb; color:white; cursor:pointer; font-weight:bold; }
    button:hover { background:#1d4ed8; }
    img { width:120px; height:120px; object-fit:cover; border-radius:10px; margin-top:5px; }
  </style>
</head>
<body>
  <h1>ðŸªª Kreator danych</h1>
  <form id="creatorForm">
    <input type="text" id="name" placeholder="ImiÄ™" required>
    <input type="text" id="surname" placeholder="Nazwisko" required>
    <input type="text" id="familyName" placeholder="Nazwisko rodowe">
    <input type="text" id="fathersName" placeholder="ImiÄ™ ojca">
    <input type="text" id="mothersName" placeholder="ImiÄ™ matki">
    <input type="number" id="day" placeholder="DzieÅ„ urodzenia (1â€“31)" min="1" max="31" required>
    <input type="number" id="month" placeholder="MiesiÄ…c (1â€“12)" min="1" max="12" required>
    <input type="number" id="year" placeholder="Rok urodzenia (np. 1998)" min="1900" max="2100" required>
    <select id="sex" required>
      <option value="">PÅ‚eÄ‡</option>
      <option value="m">MÄ™Å¼czyzna</option>
      <option value="k">Kobieta</option>
    </select>
    <label for="imageInput">ZdjÄ™cie (opcjonalnie):</label>
    <input type="file" id="imageInput" accept="image/*">
    <img id="preview" src="" alt="" hidden>
    <button type="submit">Zapisz i pokaÅ¼ dowÃ³d</button>
  </form>

  <script>
    const form = document.getElementById("creatorForm");
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    let imageBase64 = null;

    // podglÄ…d zdjÄ™cia
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        imageBase64 = e.target.result;
        preview.src = imageBase64;
        preview.hidden = false;
      };
      reader.readAsDataURL(file);
    });

    // funkcje do IndexedDB
    function getDb(){
      return new Promise((resolve, reject) => {
        const r = indexedDB.open('fobywatel', 1);
        r.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('data')){
            db.createObjectStore('data', { keyPath: 'data' });
          }
        };
        r.onsuccess = e => resolve(e.target.result);
        r.onerror = e => reject(e.target.error);
      });
    }
    function saveData(db, data){
      return new Promise((resolve, reject) => {
        const tx = db.transaction('data','readwrite');
        const store = tx.objectStore('data');
        const req = store.put(data);
        req.onsuccess = () => resolve();
        req.onerror = e => reject(e.target.error);
      });
    }

    form.addEventListener("submit", async e => {
      e.preventDefault();

      const data = {
        name: form.name.value,
        surname: form.surname.value,
        familyName: form.familyName.value,
        fathersName: form.fathersName.value,
        mothersName: form.mothersName.value,
        day: parseInt(form.day.value),
        month: parseInt(form.month.value),
        year: parseInt(form.year.value),
        sex: form.sex.value
      };

      // zapisz w localStorage
      for (const key in data) localStorage.setItem(key, data[key]);

      // zapisz w IndexedDB (zdjÄ™cie)
      const db = await getDb();
      if (imageBase64){
        await saveData(db, { data: 'image', image: imageBase64 });
      }

      // przekierowanie na kartÄ™
      window.location.href = "/dowodplska/card.html";
    });
  </script>
</body>
</html>
